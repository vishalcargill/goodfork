generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String           @id @default(cuid())
  name            String
  email           String           @unique
  passwordHash    String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  feedback        Feedback[]
  recommendations Recommendation[]
  profile         UserProfile?
  sessions        UserSession[]
  pantryItems     PantryItem[]
}

model UserProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  dietaryGoals       String[] @default([])
  allergens          String[] @default([])
  dietaryPreferences String[] @default([])
  tastePreferences   String[] @default([])
  lifestyleNotes     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Recipe {
  id                String           @id @default(cuid())
  slug              String           @unique
  sourceId          String?          @unique
  sourceUrl         String?
  author            String?
  title             String
  description       String?
  cuisine           String?
  calories          Int?
  proteinGrams      Int?
  carbsGrams        Int?
  fatGrams          Int?
  priceCents        Int              @default(0)
  tags              String[]         @default([])
  allergens         String[]         @default([])
  ingredients       String[]         @default([])
  instructions      String[]         @default([])
  imageUrl          String?
  healthyHighlights String[]         @default([])
  serves            Int?
  difficulty        String?
  prepTimeMinutes   Int?
  cookTimeMinutes   Int?
  averageRating     Float?
  ratingCount       Int?
  dishType          String?
  mainCategory      String?
  subCategory       String?
  nutrients         Json?
  timers            Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  inventory         InventoryItem?
  healthySwapFor    Recommendation[] @relation("HealthySwap")
  recommendations   Recommendation[]
  embeddings        RecipeEmbedding[]
  recipeIngredients RecipeIngredient[]
}

model InventoryItem {
  id          String          @id @default(cuid())
  recipeId    String          @unique
  quantity    Int             @default(0)
  unitLabel   String          @default("unit")
  restockDate DateTime?
  status      InventoryStatus @default(IN_STOCK)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  recipe      Recipe          @relation(fields: [recipeId], references: [id], onDelete: Cascade)
}

model Ingredient {
  id           String   @id @default(cuid())
  slug         String   @unique
  name         String
  defaultUnit  String   @default("unit")
  allergens    String[] @default([])
  tags         String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  recipes      RecipeIngredient[]
  pantryItems  PantryItem[]
}

model RecipeIngredient {
  id                 String     @id @default(cuid())
  recipeId           String
  ingredientId       String
  quantityPerServing Decimal    @db.Decimal(10, 2)
  unitLabel          String?
  notes              String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  recipe             Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient         Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
}

model PantryItem {
  id           String          @id @default(cuid())
  userId       String
  ingredientId String
  quantity     Decimal         @db.Decimal(10, 2)
  unitLabel    String          @default("unit")
  status       InventoryStatus @default(IN_STOCK)
  expiresOn    DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredient   Ingredient      @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([userId, ingredientId])
}

model Recommendation {
  id                   String               @id @default(cuid())
  userId               String
  recipeId             String
  healthySwapRecipeId  String?
  rationale            String
  healthySwapRationale String?
  status               RecommendationStatus @default(SHOWN)
  sessionId            String?
  metadata             Json?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  feedback             Feedback[]
  healthySwapRecipe    Recipe?              @relation("HealthySwap", fields: [healthySwapRecipeId], references: [id])
  recipe               Recipe               @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recipeId])
}

model Feedback {
  id               String            @id @default(cuid())
  recommendationId String
  userId           String
  action           FeedbackAction
  sentiment        FeedbackSentiment @default(NEUTRAL)
  notes            String?
  createdAt        DateTime          @default(now())
  recommendation   Recommendation    @relation(fields: [recommendationId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recommendationId])
}

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  tokenId    String   @unique
  expiresAt  DateTime
  userAgent  String?
  ipAddress  String?
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

enum RecommendationStatus {
  SHOWN
  SAVED
  ACCEPTED
  DECLINED
  SWAPPED
}

enum FeedbackSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum FeedbackAction {
  ACCEPT
  SAVE
  SWAP
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
}

model RecipeEmbedding {
  id         String           @id @default(cuid())
  recipeId   String
  provider   String
  model      String
  version    String           @default("v1")
  dimension  Int
  embedding  Float[]
  status     EmbeddingStatus  @default(ACTIVE)
  metadata   Json?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  recipe     Recipe           @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, provider, model, version])
  @@index([model])
  @@index([provider])
}

enum EmbeddingStatus {
  ACTIVE
  STALE
  FAILED
}
